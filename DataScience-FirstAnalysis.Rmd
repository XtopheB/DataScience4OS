---
title: "A step-by-step Analysis- Descriptive"
subtitle: "NSB course - Thimphu"
author: "Christophe Bontemps"
date:   "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    always_allow_html: true
    toc: yes
    toc_float: true
    keep_md: no
    code_folding: show
    code_download: true
  word_document: default
  pdf_document: default
---


```{r libraries, include=FALSE}
# Tidy data management packages
library(tidyverse)
library(data.table)

# Plotting packages
library(ggplot2)
library(RColorBrewer)

# Nice presentation of results
library(knitr)
# library(papeR)

# Tables 
library(modelsummary)
library(sjPlot) # for regression
library(gt) 
library(gtsummary)
```


```{r setup, include=FALSE}
# All graphics will have this theme
theme_set(theme_minimal())

# My colors:
SIAP.color <- "#0385a8"

# We'll see why this is important later
set.seed(123)
```

## Motivation

Descriptive statistics are essential in official statistics.  
However, they are often insufficient to understand **relationships** between variables.

They are essential, but:
  - They hide heterogeneity
  - They cannot isolate multiple effects
  - They may lead to misleading policy conclusions

We illustrate this Here

---

## A simple official statistics question

**Question:**  
How does household income vary with years of education?

---


# Data

**Variables:**
- **income**:  Household income (continuous)
- **education**: Years of education of household head (continuous)
- **age**: Age of household head (continuous)
- **sex**: Sex of household head ("Man" or "Woman)
- **education_level**: Level of education (3 levels)
- **age_group**: Age classification ("Young" , "Middle", "Old")


## Data-generating process (unknown to the analyst)

```{r include=FALSE}
n <- 600

data <- tibble(
  sex = sample(c("Men", "Women"), n, replace = TRUE),
  education_level = sample(
    c("None", "Secondary", "Tertiary"),
    n, replace = TRUE,
    prob = c(0.3, 0.4, 0.3)
  )
) %>%
  mutate(
    education = case_when(
      education_level == "None" ~ round(rnorm(n(), 5, 1)),
      education_level == "Secondary" ~ round(rnorm(n(), 10, 1)),
      education_level == "Tertiary" ~ round(rnorm(n(), 16, 1))
    ),
    age = round(rnorm(n(), mean = 40, sd = 10)),
    
    base_income = 300,
    education_effect = 20 * education,
    sex_education_bonus = if_else(
      sex == "Men" & education > 14,
      150,
      0
    ),
    income = base_income +
      education_effect +
      sex_education_bonus +
      rnorm(n(), 0, 60)
  )

# Data Simulation cleaning

data <- data %>%
  select(income, age,  education, education_level, sex) %>%
  mutate(age_group = case_when( age <20 ~ "Young",
                                age >= 20 & age < 40 ~"Middle", 
                                age >=40 ~"old"
                                ), 
         sex= as.factor(sex), 
         education_level = as.factor(education_level)
  )
  
```

# Descriptive statistics


```{r}
head(data)
```

```{r}
datasummary_skim(data, type = "numeric")
```


```{r}
data %>%
  group_by(sex) %>%
  summarise(
    N = n(),
    mean_income = round(mean(income), 1),
    sd_income = round(sd(income), 1),
    min_income = round(min(income), 1),
    max_income = round(max(income), 1),
    mean_years_education = round(mean(education), 1),
    mean_age = round(mean(age), 1),
    .groups = "drop"
  )
```



## Average income by sex

```{r}
data %>%
  group_by(sex) %>%
  dplyr::summarise(mean_income = mean(income), .groups = "drop") %>%
  ggplot(aes(sex, mean_income, fill = sex)) +
  geom_col() +
  labs(
    title = "Average income by sex",
    y = "Mean income",
    x = NULL
  ) +
  theme(legend.position = "none")
```

**Tempting interpretation:**  
> Men earn more than women.

# Adding a continuous variable

## Scatter plot: income vs years of education

```{r}
ggplot(data, aes(education, income)) +
  geom_point(color = SIAP.color, alpha = 0.5) +
  labs(
    title = "Income and years of education",
    x = "Years of education",
    y = "Income"
  ) 
```

This suggests a positive relationship, but variability is large.

# Adding more information

## Income, education and age

```{r}
ggplot(data, aes(education, income, color = age_group)) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Income and education",
    subtitle = "Color is age group",
    x = "Years of education",
    y = "Income",
    color = "Age"
  )
```

## Income, and age

```{r}
ggplot(data, aes(age, income)) +
  geom_point(alpha = 0.6) +
  # geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Income and age",
    x = "Age",
    y = "Income",
    color = "Age"
  )
```
The relationship is still hard to interpret clearly.


# Limitation of descriptive statistics

## Why this is still not enough

- Visual inspection is subjective
- Effects are hard to quantify
- Multiple variables are difficult to handle simultaneously

This motivates regression.

# Regression model

## Linear model with all variables

```{r, echo=TRUE}
model <- lm(income ~ education + age + sex , data = data)
summary(model)
```


```{r}
modelsummary(
  model,
  statistic = "std.error",
  stars = TRUE,
  output = "html"
)
```

```{r}
tab_model(
  model,
  title = "Regression of Income (Y)  on education, age and sex (Xs)",
  show.se = TRUE,
  show.p = TRUE,
  dv.labels = "Income",
  file = NULL
)
```


This model:

- Quantifies the effect of education
- Controls for age and sex

```{r}
ggplot(data, aes(education, income)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Income and years of education",
    subtitle = "Regression line adjusted for age and sex",
    x = "Years of education",
    y = "Income"
  ) 
```

```{r}
# Create prediction grid from the fitted model
pred_data <- expand.grid(
  education = seq(min(data$education),
                         max(data$education),
                         length.out = 100),
  sex = unique(data$sex),
  age = mean(data$age)
)

pred_data$pred_income <- predict(model, newdata = pred_data)

ggplot(data, aes(education, income, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_line(
    data = pred_data,
    aes(education, pred_income, color = sex),
    linewidth = 1
  ) +
  labs(
    title = "Income and years of education by sex",
    subtitle = "Same regression model, adjusted for age",
    x = "Years of education",
    y = "Income",
    color = "Sex"
  ) +
  theme_minimal()
```


# Key message

## Take-away for official statistics

- Descriptive statistics are indispensable
- But they are not sufficient for policy analysis
- Regression is a natural and necessary extension

**Descriptive statistics describe.  
Regression explains.**

## Carreful of partial analysis


## Income–education relationship by sex
If we do the analysis by sex (that is for women only vs for Men only), we have this: 


```{r}
ggplot(data, aes(education, income, color = sex)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Income–education relationship by sex",
    x = "Years of education",
    y = "Income",
    color = "Sex"
  ) 
```

We now see:

- Education increases income for both sexes
- The effect is **stronger for young women** !!

But we are not comparing the exact same thing! 
- We are not adjusting for **age**, we are just doindg 2 diferent analysis.  



