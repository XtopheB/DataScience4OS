---
title: "A step-by-step Analysis- Descriptive"
subtitle: "NSB course - Thimphu"
author: "Christophe Bontemps"
date:   "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    always_allow_html: true
    toc: yes
    toc_float: true
    keep_md: no
    code_folding: show
    code_download: true
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
# My default setting for this document
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  cache = FALSE,
  comment = NA
)
```


```{r libraries, include=FALSE}
# Tidy data management packages
library(tidyverse)
library(data.table)

# Plotting packages
library(ggplot2)
library(RColorBrewer)
library(GGally)

# Nice presentation of results
library(knitr)
# library(papeR)

# Tables 
library(modelsummary)
library(sjPlot) # for regression
library(gt) 
library(gtsummary)
```


```{r setup_graphics, include=FALSE}
# Setting the theme for graphics
theme_set(theme_minimal() + theme(panel.grid = element_blank()))
```


```{r seed, include=FALSE}
# We'll see why this is important later
set.seed(2512) # For reproducibility
```

```{r colors, echo = FALSE}

# My colors:
SIAP.color <- "#0385a8"

# I will use my preferred colors for sex all along the document
sex_colors <- c(
  "Men" = "coral",       
  "Women" = "#9B59B6"     
)

age_colors <- c(
  "Young" = "#F39C12" ,
  "Middle" = "#C0504D",
  "Old" = "#8da0cb"
)

# Other colors
Some_colors <-c(
    "Young" = "#66c2a5",      # Soft blue
    "Middle" = "#F39C12",     # Warm orange
    "old" = "#C0504D"         # Muted burgundy/red
)
# Then: 
 # - Points and lines (and any others)
 #        scale_color_manual(values = sex_colors)
 #  - Bar chart
 #        scale_fill_manual(values = sex_colors)
 
  
```

## Motivation

Descriptive statistics are essential in official statistics.  
However, they are often insufficient to understand **relationships** between variables.

They are essential, but:
  - They hide heterogeneity
  - They cannot isolate multiple effects
  - They may lead to misleading policy conclusions

We illustrate this here in this reproducible example. 

---

## A simple question

**Question:**  
> How does household income vary with education?

---


# Data

**Variables:**

- **income**:  Household income (continuous)
- **education**: Adjusted years of education of household head (continuous)
- **age**: Age of household head (continuous)
- **sex**: Sex of household head ("Man" or "Woman)
- **education_level**: Level of education (3 levels)
- **age_group**: Age classification ("Young" , "Middle", "Old")



```{r DGP, echo=FALSE}
# Data-generating process (unknown to the analyst)

n <- 600
data <- tibble(
  sex = sample(c("Men", "Women"), n, replace = TRUE),
  age = round(rnorm(n, mean = 40, sd = 10)),
  #education = round(rnorm(n, mean = 10, sd = 4))
  education = rnorm(n, mean = 10, sd = 4)
) %>%
  mutate(
    # Constrain education to realistic range (0-20 years)
    education = pmax(0, pmin(20, education)),
    
    # Create education levels based on continuous education
    education_level = case_when(
      education < 8 ~ "Primary",
      education < 14 ~ "Secondary",
      education >= 14 ~ "Tertiary"
    ),
    
    # Income calculation
    base_income = 300,
    education_effect = 20 * education,
    sex_education_bonus = if_else(
      sex == "Men" & education > 14,
      300,
      100
    ),
    income = base_income +
      education_effect +
      sex_education_bonus +
      rnorm(n(), 0, 60)
  )

# Data Simulation cleaning
data <- data %>%
  select(income, age,  education, sex, education_level) %>%
  mutate(age_group = case_when( age <20 ~ "Young",
                                age >= 20 & age < 40 ~"Middle", 
                                age >=40 ~"Old"
                                ), 
         age_group = factor(age_group, levels = c("Young", "Middle", "Old")),
         sex= as.factor(sex), 
         education_level = as.factor(education_level)
  )
```

# Data Analysis


> First one can have a look at the dat set (raw data). Here only 6 first observations. 

```{r}
head(data)
```

> **Question**:   How many variables in the data set? 


###  Descriptive statistics

We have both continuous and categorical variables:

```{r}
datasummary_skim(data, 
                 type = "numeric", 
                 title = "Continuous variables")
```


```{r}
datasummary_skim(data,
                 type = "categorical",
                 title = " Categorical (factors)")
```

```{r}
data %>%
  group_by(sex) %>%
  summarise(
    N = n(),
    mean_income = round(mean(income), 1),
    sd_income = round(sd(income), 1),
    min_income = round(min(income), 1),
    max_income = round(max(income), 1),
    mean_years_education = round(mean(education), 1),
    mean_age = round(mean(age), 1),
    .groups = "drop"
  )
```



## Average income by sex

```{r}
data %>%
  group_by(sex) %>%
  dplyr::summarise(mean_income = mean(income), .groups = "drop") %>%
  ggplot(aes(sex, mean_income, fill = sex)) +
  geom_col(width = 0.2) +
  scale_fill_manual(values = sex_colors) +
  labs(
    title = "Average income by sex",
    y = "Mean income",
    x = NULL
  ) +
  coord_flip()+
  theme(legend.position = "none")
```

**Tempting interpretation:**  
> Men earn more than women.

# Adding a continuous variable

## Scatter plot: income vs education

```{r basic-scatterplot}
ggplot(data, aes(education, income)) +
  geom_point(color = SIAP.color, alpha = 0.5) +
  labs(
    title = "Income and education",
    x = "Education (Adjusted years)",
    y = "Income"
  ) 
```

This suggests a positive relationship, but variability is large.

# Adding more information

## Income, education and age

## Income, and age

```{r}
ggplot(data, aes(age, income)) +
  geom_point(alpha = 0.6, color = "darkgrey") +
  # geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Income and age",
    x = "Age",
    y = "Income",
    color = "Age"
  )
```
The relationship is still hard to interpret clearly.

### Income and Education , by age groups


```{r warning=FALSE}
ggplot(data, aes(education, income, color = age_group)) +
  geom_point(alpha = 0.6, position = position_jitter(width = 0.3, height = 0)) +
  facet_wrap(~ age_group) +
  scale_color_manual(values = age_colors) +
  labs(
    title = "Income and education",
    subtitle = "Color is age group",
    x = "Education (Adjusted years)",
    y = "Income",
    color = "Age"
  ) +
  theme(
    panel.border = element_rect(color = "grey70", fill = NA, linewidth = 0.5),
  # axis.line.y = element_line(color = "black"),
  # axis.ticks.y = element_line(color = "black"),
  panel.spacing.x = unit(2, "lines"),  # Horizontal spacing
  panel.spacing.y = unit(1, "lines")   # Vertical spacing (if wrapped)
)
```

## Can we plot all interactions? 

```{r}
# Scatterplot matrix
GGally::ggpairs(data, 
        columns = c("income", "age", "education"),
        aes(color = sex, alpha = 0.3),
        upper = list(continuous = "cor"),      # Correlations in upper triangle
        lower = list(continuous = "points"),   # Scatterplots in lower triangle
        diag = list(continuous = "densityDiag")) + # Density plots on diagonal
  scale_color_manual(values = sex_colors) +
  scale_fill_manual(values = sex_colors)
```



# Limitation of descriptive statistics

## Why this is still not enough

- Visual inspection is difficult sometimes
- Effects are hard to quantify
- Multiple variables are difficult to handle simultaneously, the number of interactions is important. 

This motivates regression.

# Regression model

## Linear model with all variables

```{r, echo=TRUE}
model <- lm(income ~ education + age + sex , data = data)
summary(model)
```


```{r}
modelsummary(
  model,
  statistic = "std.error",
  stars = TRUE,
  output = "html"
)
```

```{r}
tab_model(
  model,
  title = "Regression of Income (Y)  on education, age and sex (Xs)",
  show.se = TRUE,
  show.p = TRUE,
  dv.labels = "Income",
  file = NULL
)
```


This model:

- Quantifies the effect of education
- Controls for age and sex

```{r regression_line}
ggplot(data, aes(education, income)) +
  geom_point(alpha = 0.4, color = SIAP.color) +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  labs(
    title = "Income and education",
    subtitle = "Regression line adjusted for age and sex",
    x = "Education (Adjusted years)",
    y = "Income"
  ) 
```

```{r}
# Create prediction grid from the fitted model
pred_data <- expand.grid(
  education = seq(min(data$education),
                         max(data$education),
                         length.out = 100),
  sex = unique(data$sex),
  age = mean(data$age)
)

pred_data$pred_income <- predict(model, newdata = pred_data)

ggplot(data, aes(education, income, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_line(
    data = pred_data,
    aes(education, pred_income, color = sex),
    linewidth = 1 ) +
  scale_color_manual(values = sex_colors)+
  labs(
    title = "Income and education by sex",
    subtitle = "Same regression model, adjusted for age",
    x = "Education (Adjusted years)",
    y = "Income",
    color = "Sex" ) +
  theme_minimal()
```


# Key message

## Take-away for official statistics

- Descriptive statistics are indispensable
- But they are not sufficient for policy analysis
- Regression is a natural and necessary extension

**Descriptive statistics describe.  
Regression explains.**

## Carreful of partial analysis


## Income–education relationship by sex
If we do the analysis by sex (that is for women only vs for Men only), we have this: 


```{r}
ggplot(data, aes(education, income, color = sex)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = sex_colors)+
  labs(
    title = "Income–education relationship by sex",
    x = "Education (Adjusted years)",
    y = "Income",
    color = "Sex"
  ) 
```

We now see:

- Education increases income for both sexes
- The effect is **stronger for young women** !!

But we are not comparing the exact same thing! 
- We are not adjusting for **age**, we are just doindg 2 diferent analysis.  



##  Regression explained

```{r regression-explained}
# First,get predictions in the data set

data <- data %>%
  mutate(predicted = predict(model),
         residual = income - predicted,
         abs_residual = abs(residual)
  )
                             
# Select 8 random points to show residuals

# Divide education into bins and pick one extreme point from each bin
sample_points <- data %>%
  mutate(edu_bin = cut(education, breaks = 9)) %>%  # Create 8 bins
  group_by(edu_bin) %>%
    sample_n(1) %>% # One residual in each bin
  ungroup() %>%
  select(-edu_bin)

```


```{r regression-RedPoints}
# Create the plot
ggplot(data, aes(education, income)) +
  geom_point(alpha = 0.4, color = "grey") +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  
  # Highlight the sampled points
  geom_point(data = sample_points,
             aes(education, income),
             color = "red", 
             size = 2,
             alpha = 0.8) +
  labs(
    title = "Income and education",
    subtitle = "Highlighting points (in red) far from the regression line)",
    x = "Education (Adjusted years)",
    y = "Income"
  )
```


```{r regression-RedVlines}
# Create the plot
ggplot(data, aes(education, income)) +
  geom_point(alpha = 0.4, color = "grey") +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  # Add red vertical lines for residuals
  geom_segment(data = sample_points,
               aes(x = education, xend = education,
                   y = income, yend = predicted),
               color = "red", 
               linewidth = 1,
               linetype = "solid") +
  # Highlight the sampled points
  geom_point(data = sample_points,
             aes(education, income),
             color = "red", 
             size = 1.5,
             alpha = 0.8) +
  labs(
    title = "Income and education",
    subtitle = "Red lines show residuals (observed - predicted)",
    x = "Education (Adjusted years)",
    y = "Income"
  )
```



